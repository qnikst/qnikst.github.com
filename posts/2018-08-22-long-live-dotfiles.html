<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Qnikst blog - Making personal environment and long live dotfiles</title>
    <!-- Bootstrap -->
    <link href="../style.css" rel="stylesheet" media="screen">
    <script src="https://code.jquery.com/jquery-latest.js"></script> 
    <script src="../js/bootstrap.min.js"></script>
    
    
</head>

<body>
  <div id="header">
      <div id="caption"><a href="../">Qnikst's blog</a></div>
      <div id="navigation">
      <a href="../posts.html">Archive</a>
      <a href="../projects.html">Projects</a>
      <a href="../contact.html">Contacts</a>
      <a href="../rss.xml">RSS</a>
      </div>
  </div>

  <div id="content">
    <div class="page-header">
    <div class="right">
      <strong>August 22, 2018</strong>
    </div>
    <h1>Making personal environment and long live dotfiles</h1>
    <div class="post-author">by <em>Alexander Vershilov</em>  </div>
    <div class="keywords"><strong>Keywords:</strong> <a href="../tags/nix.html">nix</a>, <a href="../tags/configuration.html">configuration</a></div>
</div>

<p>Some time ago I installed <a href="https://nixos.org/">NixOS</a>, and one thing that I had a problem with was understanding how to set up user environment. You can can configure NixOS declaratively with a description in a single file <code>/etc/nixos/configuration.nix</code>, but all applications set up there get installed system-wide. Instead, you usually want to have your user environment to be configured per your user. Also you may want to move your environment from one host to another (possibly to another distribution or even to another OS). Updating configuration.nix looks like a too heavy-weight solution for such a task.</p>
<p>Other solutions that I’ve seen were building of one’s own environment or using <a href="https://github.com/tldr-pages/tldr/blob/master/pages/common/nix-env.md">nix-env</a> for installing applications per user. I was not able to adopt the former solution, and the latter does not provide declarative config, and one may collect lots of garbage of applications she runs once. Besides, it would be nice to control dotfiles in the same style.</p>
<p>One day my colleague <a href="https://github.com/nmattia">Nicolas Mattia</a> suggested me to look at the tool he uses, called <a href="https://github.com/nmattia/homies">homies</a>, the one he had excellently described in his <a href="http://nmattia.com/posts/2018-03-21-nix-reproducible-setup-linux-macos.html">blog</a>. I think everyone should read and check that :). Unfortunately, this approach, at least up to my understanding should exist for each user, because it’s not customisable. So I’ve started my project <a href="https://github.com/qnikst/homster">homster</a> that is solving the same problem. Currently it’s primarily based on the <code>homies</code> though in the future it’s going to diverge.</p>
<p>The general structure of the project is as follows. There is a <code>default.nix</code> file that describes all the packages and the modified ones that I use. In each modified package I pass my config, or it’s configured to read system config from the nix package directory so I can configure common options in the homster project and update them on the host by usual means.</p>
<p>So it seems that I have found the solution to all my needs and I can have a declarative configuration for the user environment. I still can use <code>nix-env -i</code> for temporarily needed packages, but <code>nix-env -f homster/default.nix -i --remove-all</code> command updates and cleans my environment. Most of the dotfiles can be kept in the project. Also, I can set up my environment anywhere where I can install <code>nix</code> package manager.</p>
<p>While implementing this the most interesting problem was <code>git</code>. Git searches for its configuration in 3 places according to the man page:</p>
<ol type="1">
<li>system-wide: <code>(prefix)/gitconfig</code></li>
<li>user-wide: <code>$(HOME)/.gitconfig</code> or <code>$XDG_CONFIG_DIR/git/gitconfig</code></li>
<li>project-wide: <code>~/.git/config</code></li>
</ol>
<p>Besides, it takes <code>--config</code> option that overrides config search entirely. We can’t use <code>--config</code> because that overrides project specific options, we can’t update user-wide file with nix, so the only option left is the system-wide config. So we need to understand what is <code>(prefix)</code>. Man pages tell that it’s a value of the <code>PREFIX</code> environment option. Let’s check nixpkgs:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a>    <span class="st">&quot;prefix=</span><span class="dt">\$</span><span class="st">{out}&quot;</span></span></code></pre></div>
<p>https://github.com/NixOS/nixpkgs/blob/54ba2c9afca07b0f14763b3697d00b637b2461e0/pkgs/applications/version-management/git-and-tools/git/default.nix#L86</p>
<p>It seems that nix installs that, but let us check it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">strace</span> git config <span class="op">2&gt;&amp;1</span> <span class="kw">|</span> <span class="fu">grep</span> gitconfig</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">access</span>(<span class="st">&quot;/etc//gitconfig&quot;</span>, R_OK)         = <span class="ex">-1</span> ENOENT (No such file or directory)</span></code></pre></div>
<p>Seems not to be what we were expecting. The story continues, we need to understand where does git looks for a config. You can find it on GitHub (modulo the version that I’ve used, but it’s irrelevant for the code I’m interested in) <a href="https://github.com/git/git/blob/7e8bfb0412581daf8f3c89909f1d37844e8610dd/config.c#L1634-L1640" class="uri">https://github.com/git/git/blob/7e8bfb0412581daf8f3c89909f1d37844e8610dd/config.c#L1634-L1640</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">const</span> <span class="dt">char</span> *git_etc_gitconfig(<span class="dt">void</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>{</span>
<span id="cb3-3"><a href="#cb3-3"></a>	<span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span> *system_wide;</span>
<span id="cb3-4"><a href="#cb3-4"></a>	<span class="cf">if</span> (!system_wide)</span>
<span id="cb3-5"><a href="#cb3-5"></a>		system_wide = system_path(ETC_GITCONFIG);</span>
<span id="cb3-6"><a href="#cb3-6"></a>	<span class="cf">return</span> system_wide;</span>
<span id="cb3-7"><a href="#cb3-7"></a>}</span></code></pre></div>
<p>Okay, what is <code>ETC_GITCONFIG</code> <a href="https://github.com/git/git/blob/1f1cddd558b54bb0ce19c8ace353fd07b758510d/configure.ac#L387-L391" class="uri">https://github.com/git/git/blob/1f1cddd558b54bb0ce19c8ace353fd07b758510d/configure.ac#L387-L391</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">GIT_PARSE_WITH_SET_MAKE_VAR</span>(gitconfig, ETC_GITCONFIG,</span>
<span id="cb4-2"><a href="#cb4-2"></a>			<span class="ex">Use</span> VALUE instead of /etc/gitconfig as the</span>
<span id="cb4-3"><a href="#cb4-3"></a>			<span class="ex">global</span> git configuration file.</span>
<span id="cb4-4"><a href="#cb4-4"></a>			<span class="ex">If</span> VALUE is not fully qualified it will be interpreted</span>
<span id="cb4-5"><a href="#cb4-5"></a>			<span class="fu">as</span> a path relative to the computed prefix at runtime.)</span></code></pre></div>
<p>Finally, after searching what <code>GIT_PARSE_WITH_SET_MAKE_VAR</code> means, we can find that we need to pass <code>--with-gitconfig=name</code> as a parameter to the configure.</p>
<p>So now we need to patch nix package for <code>git</code> to do that. As usual, we want to make it declaratively and easy to change without redoing the work that NixOS maintainers already did like applying patches and packaging.</p>
<p>Everything described above can be done pretty quickly in <code>nix</code>, in my <code>homster/git/default.nix</code> I can override default package for git as:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">git.overrideAttrs</span> (old: {</span>
<span id="cb5-2"><a href="#cb5-2"></a>   <span class="ex">configureFlags</span> = [ <span class="st">&quot;--with-gitconfig=</span><span class="va">$out</span><span class="st">/etc/gitconfig ];</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">})</span></span></code></pre></div>
<p><code>nix</code> interprets the <code>$out</code> variable and substitutes exact hash there. Then we can copy our file to the right place and get a new system-wide configuration that is controlled by us.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">strace</span> git config <span class="op">2&gt;&amp;1</span> <span class="kw">|</span> <span class="fu">grep</span> gitconfig</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ex">access</span>(<span class="st">&quot;/nix/store/66hi8rssnvhlxbwjg3qkc4bcs76fp8np-git-2.16.4/etc/gitconfig&quot;</span>, R_OK) = <span class="ex">0</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="ex">openat</span>(AT_FDCWD, <span class="st">&quot;/nix/store/66hi8rssnvhlxbwjg3qkc4bcs76fp8np-git-2.16.4/etc/gitconfig&quot;</span>, O_RDONLY) = <span class="ex">3</span></span></code></pre></div>
<p>exactly what is needed.</p>

<hr />
<div id="sociallinks" class="pull-left">
    <strong>Share on:</strong>
  <a href="https://twitter.com/home?status=http://qnikst.github.io/posts/2018-08-22-long-live-dotfiles.html" target="_blank" class="social" title="twit it">t</a>  
  <a href="http://www.facebook.com/sharer/sharer.php?u=http://qnikst.github.io/posts/2018-08-22-long-live-dotfiles.html" target="_blank" class="social" title="share on facebook">F</a> 
  <a href="https://plus.google.com/share?url=http://qnikst.github.io/posts/2018-08-22-long-live-dotfiles.html" target="_blank" class="social" title="share on g+">g</a>
</div>

<br class="clearfix" />
<hr />


<div id="disqus_thread"></div>
  <script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'qnikst'; // required: replace example with your forum shortname

  (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                                                                                           

  </div>

  <footer>
    powered by <a href="http://jaspervdj.be/hakyll">Hakyll</a> &amp; <a href="http://johnmacfarlane.net/pandoc/">Pandoc</a>
  </footer>

<script type="text/javascript">
    //      <noscript> я очень хочу вас посчитать, напишите комментарий хотя бы, пожааалуйста </noscript>
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-38941774-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>

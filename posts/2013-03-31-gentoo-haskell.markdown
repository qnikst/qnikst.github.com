----
title: Немного о gentoo-haskell 
author: Alexander Vershilov
date: 2013/03/31
tags: gentoo, haskell
license: by-nc-sa
----

Как всем известно у haskell пакетов существует прекрасная система с 
сборки с центральным репозиторием, в котором хранятся пакеты, однако
у этой проблемы существует ряд минусов:

  * далеко не все пакеты собираются друг с другом даже если эти версии 
    разрешены в cabal файле.
  * далеко не все пакеты протестированы
  * часть пакетов нацелены на работу под конкретной платформой и 
  обновлять их до выхода следующей платформы не собираются
  * при обновлении пакета нужно пересобирать все обратные зависимости
  * в случае если нужны профилировочные библиотеки, то нужно пересобирать
  все зависимости с опциями профилировки.
  * полное отстуствие верификации исходников, которые вы качаете.

Все эти пункты делают использование haskell не очень приятным, так же
проблема усугубляется тем, что во многих дистрибутивах представлены 
устаревшие версии пакетов, за которыми не успевают следить (не верите, то
можете посмотреть результаты [haskell survey](https://docs.google.com/forms/d/1y5WtrCB7O9-jb-2Mzo1MtkToh4O6oY2oBXGkc_Q-cy0/viewanalytics )
Обычным решением является использование cabal на пользовательном уровне, 
или сборка в песочницах. Но иногда бывают способы и лучше.

Естественно, каждый дистрибутив пытается по своему предложить решение проблем.
В посте описана краткая инфрастурктура gentoo-linux и дополнительные пакеты
сильно упрощающие работу с haskell, в целом пост может быть интересен, как 
пользователям Gentoo, так интересующимся пользователям других дистрибутивов,
даже в том случае если не они не планируют переход или использование Gentoo Linux.

1. Gentoo работает под многими платформами: (alpha amd64 ia64 ppc ppc64 sparc x86) 
и под каждую есть поставка ghc и пакетов. Сам пакет ghc можно поставить в бинарном
виде, в том случае, если его сборка слишком тяжела для хоста.

2. Для исправления зависимостей существует программа haskell-updater, которая 
находит все "поломанные" зависимости и пересобирает нужные пакеты. Не так давно для
улучшения ситуации добавлен механизм подслотов (subslots) специальная форма зависимостей 
позволяющая указать, то что программа должна быть обновлена в случае обновления зависимости. 
В текущий момент этот метод не может решить все проблемы (и даже приводит к некоторым новым), 
то уже в скором времени подслоты будут [рекурсивными](https://bugs.gentoo.org/show_bug.cgi?id=449094 )
и полностью решат проблему
автоматического обновления зависимостей 

3. Большая часть пакетов доступных на Hackage может быть установлена из оверлея gentoo-haskell.
Это надет дополнительный слой, в котором можно провести дополнительные исправления,
такие как фиксация зависимостей и добавление патчей, плюс с каждым пакетом ассоциирована
хэш сумма, которая ползволяет автоматически проверять валидность скачанных исходников.


В нашем проекте проводятся следующие политики:

  1. в оверлее держится последняя версия пакета, и она патчится таким образом,
    чтобы она могла работать с последними версиями других пакетов. Для некоторых 
    пакетов есть исключения по запросам от пользователей или в случае серьезного
    изменеия апи.
  2. Во всех пакетах проверяется то, что тесты проходятся (если они есть).
  3. сделаны утилиты для простого создания новых пакетов _действительно простого_

Таким образом в gentoo можно спокойно использовать haskell на системном уровне 
используя песочницы только в исключительных ситуациях.

Так же в дистрибутив входят допонительные полезные утилиты такие как hoogle с
поддержкой локальной базы (т.е. всех установленных пакетов).

Если кому-то интересны подробности, шаги по быстрой установке или хочется рассказать,
как в вашем дистрибутиве решаются подобные проблемы, то добро пожаловать в комментарии.

P.S. и важно, что gentoo можно поставить под любой вашей осью, данных механизм
называется gentoo prefix, и подробности можно найти [тут](http://www.gentoo.org/proj/en/gentoo-alt/prefix/).

Полезные ссылки:

[1] Страница на gentoo wiki: [http://wiki.gentoo.org/wiki/Haskell]()

[2] Тематический блог: [http://gentoohaskell.wordpress.com/]()

[3] Haskell wiki: [http://www.haskell.org/haskellwiki/Gentoo]()

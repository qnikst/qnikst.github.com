<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Qnikst blog RSS feed - Post tagged pam</title>
    <link href="https://qnikst.github.io/tags/pam.xml" rel="self" />
    <link href="https://qnikst.github.io" />
    <id>https://qnikst.github.io/tags/pam.xml</id>
    <author>
        <name>Alexander Vershilov</name>
        <email>alexander.vershilov@gmail.com</email>
    </author>
    <updated>2013-02-04T00:00:00Z</updated>
    <entry>
    <title>Сохранение всех задач su- в свою cgroup.</title>
    <link href="https://qnikst.github.io/posts/2013-02-04-su-pam-cgroup-log.html" />
    <id>https://qnikst.github.io/posts/2013-02-04-su-pam-cgroup-log.html</id>
    <published>2013-02-04T00:00:00Z</published>
    <updated>2013-02-04T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>Стоит задача: необходимо все программы запущенные через ‘su’ определить в собственные cgroups. Это можно сделать за три простые шага.</p>
<ol type="1">
<li>инициализируем нужную цгруппу, для этого нам нужна именованная группа, чтобы исключить пересечение с системными группами: (данный шаг желательно делегировать системе инициализации дистрибутива)</li>
</ol>
<pre class="shell"><code>  localhost qnikst # mkdir /sys/fs/cgroup/su-log
  localhost qnikst # mount -n -t cgroup -o none,nodev,noexec,nosuid,name=test test /sys/fs/cgroup/su-log</code></pre>
<ol start="2" type="1">
<li>Пишем простой баш скрипт: в этом сприпте мы создаём каталог для пользователя (если его нет и помещаем туда родительскую задачу (ту, пользуется средствами pam)</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">localhost</span> qnikst <span class="co"># cat /usr/local/bin/pam_exec_test.sh </span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#!/bin/sh</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="va">p=</span>/sys/fs/cgroup/su-log/<span class="va">${PAM_RUSER}</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> <span class="st">&quot;</span><span class="va">${p}</span><span class="st">&quot;</span><span class="bu"> ]</span> <span class="kw">&amp;&amp;</span> <span class="kw">\</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>   <span class="fu">mkdir</span> <span class="va">${p}</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="bu">echo</span> <span class="va">${PPID}</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">${p}</span><span class="st">&quot;</span>/tasks</span></code></pre></div>
<ol start="3" type="1">
<li>пишем правило для pam.d (логи опциональны)</li>
</ol>
<pre><code>session    optional             pam_exec.so   log=/var/log/pam_test_su.log seteuid /usr/local/bin/pam_exec_test.sh</code></pre>
<ol start="4" type="1">
<li>наслаждаемся результатом.</li>
</ol>
<p>В данном решении есть проблема: будучи суперпользователем пользователь может перемещать свои задачи по cgroup-ам, для решения этой проблемы нужно писать политику selinux запрещающую переносить задачи выше, чем cgroup породившего их процесса.</p>]]></summary>
</entry>

</feed>
